/* --- style.css --- */
:root{
  --bg1:#3f3f3f; --bg2:#e5b85a; --bg3:#6f6f6f;
  --accent:#f2b84c; --danger:#ff6b6b; --play:#4cd137;
  --text:#ffffff; --text-dark: #3e3e3e; --panel-bg: rgba(255, 255, 255, 0.95);
  --shadow:0 18px 60px rgba(0,0,0,.35);
  --radius:16px;
  --font: 'Mochiy Pop One', sans-serif;
  
  --c1: #ff4757; --c2: #ffa502; --c3: #eccc68; --c4: #2ed573;
  --c5: #1e90ff; --c6: #3742fa; --c7: #a55eea;

  /* EX Mode Colors */
  --ex-bg1: #0f0c29;
  --ex-bg2: #302b63;
  --ex-bg3: #24243e;
  --ex-title: #ff6b81;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0; font-family:var(--font); color:var(--text);
  background:#111; overflow:hidden; user-select:none;
  touch-action: manipulation;
  overscroll-behavior: none;
}

/* Safe-area padding for notches/home bar */
:root{
  --sat: env(safe-area-inset-top);
  --sar: env(safe-area-inset-right);
  --sab: env(safe-area-inset-bottom);
  --sal: env(safe-area-inset-left);
}
.topbar{
  padding-top: calc(var(--sat) * 0.9);
  height: calc(60px + var(--sat) * 0.9);
  padding-left: calc(20px + var(--sal));
  padding-right: calc(20px + var(--sar));
}

/* Play UI safe-area */
.play-controls{
  left: calc(20px + var(--sal));
  top: calc(70px + var(--sat));
}
.play-timer-area{
  right: calc(20px + var(--sar));
  top: calc(70px + var(--sat));
}

@media (max-width: 740px), (max-height: 520px){
  .play-controls{
    top: auto;
    left: 50%;
    right: auto;
    bottom: calc(12px + var(--sab));
    transform: translateX(-50%);
    flex-wrap: wrap;
    justify-content: center;
  }
  .play-timer-area{
    top: calc(12px + var(--sat));
    right: calc(12px + var(--sar));
    font-size: 13px;
    padding: 6px 10px;
  }
  .play-intro h1{ font-size: 28px; }
  .play-intro p{ font-size: 14px; }
}


/* Flash Reset Effect */
body::after {
  content: ""; position: fixed; inset: 0; background: #fff;
  opacity: 0; pointer-events: none; z-index: 9999;
  transition: opacity 0.5s ease-out;
}
body.flash-reset::after { opacity: 1; transition: none; }

/* Screens */
.screen{ position:absolute; inset:0; display:none; opacity:0; pointer-events:none; transition: opacity 0.4s ease, transform 0.4s ease; }
.screen.screen--active{ display:block; opacity:1; pointer-events:auto; transform: scale(1); }

/* Background & Titles */
.bg{ 
  position:absolute; inset:-20%; 
  background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 42%, var(--bg3) 100%); 
  filter:saturate(1.05); 
  transition: background 1.5s ease; /* 滑らかな切り替え */
}
.bg::after{ content:""; position:absolute; inset:0; background: radial-gradient(circle at 72% 40%, rgba(255,255,255,.12), transparent 55%), repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0 1px, transparent 1px 9px); mix-blend-mode: overlay; opacity:.65; }

/* EX Mode Background (Space) */
.bg.ex-mode {
  background: linear-gradient(180deg, var(--ex-bg1) 0%, var(--ex-bg2) 50%, var(--ex-bg3) 100%);
}

/* Space Particles */
.space-stars {
  position: absolute; inset: 0; pointer-events: none;
  opacity: 0; transition: opacity 1.5s ease;
}
.space-stars.active { opacity: 1; }
.star {
  position: absolute; background: #fff; border-radius: 50%;
  /* アニメーション名を変更 */
  animation: spaceFloat infinite linear;
}

/* 点滅しながらゆっくり流れるアニメーション */
@keyframes spaceFloat {
  0% {
    opacity: 0;
    transform: translateY(0) scale(0.5);
  }
  20% {
    opacity: 1;
    transform: translateY(-20px) scale(1.2);
  }
  80% {
    opacity: 0.8;
    transform: translateY(-80px) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateY(-100px) scale(0.5);
  }
}

.titleWrap{ position:relative; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; perspective: 1200px; }
.screen--shatter .logoStage, .screen--shatter .menu { transition: transform 0.8s cubic-bezier(0.1, 0.9, 0.2, 1), opacity 0.5s ease; pointer-events: none; }
.logoStage{ position:relative; width: min(860px, 90vw); margin: 0 auto; z-index: 10; margin-top: clamp(-80px, -10vh, -20px); }
.logoCanvas, .logoFallback{ width: 100%; height: auto; display: block; filter: drop-shadow(0 14px 30px rgba(0,0,0,.25)); }
.logoFallback{ display:none; }
.logoCanvas{ opacity:0; transform: translateY(20px) scale(.985); background: transparent; }
#titleScreen.is-logo-running .logoCanvas{ animation: logoPop 900ms cubic-bezier(.18,.9,.2,1) forwards, logoFloat 3200ms ease-in-out 980ms infinite; }
#titleScreen.is-logo-done .logoCanvas{ opacity:1; transform:translateY(0) scale(1); animation: logoFloat 3200ms ease-in-out infinite; }
.menu{ margin-top: -20px; display:flex; flex-direction: column; gap: 30px; z-index: 10; transform-style: preserve-3d; transform: rotateX(55deg) rotateZ(35deg); opacity:0; pointer-events:none; transition: opacity .35s ease, transform .35s ease; }
#titleScreen.is-logo-done .menu{ opacity:1; pointer-events:auto; }

.btn3d{ border:none; background:transparent; padding:0; cursor:pointer; display:flex; gap:15px; position:relative; transform-style:preserve-3d; transition:transform 0.2s ease; }
.btn3d::before { content:""; position:absolute; inset:-30px; transform:translateZ(0); }
#btnEditor { padding-left: 80px; }
.btn3d span{ display:flex; justify-content:center; align-items:center; position:relative; width:clamp(40px, 11vmin, 110px); height:clamp(40px, 11vmin, 110px); background:#fdfdfd; border:2px solid #ddd; border-radius:12px; box-shadow: 1px 1px 0 #bbb, 2px 2px 0 #bbb, 3px 3px 0 #bbb, 4px 4px 0 #bbb, 5px 5px 0 #bbb, 15px 15px 30px rgba(0,0,0,0.3); transform-style:preserve-3d; transition:transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s; pointer-events:auto; }
.btn3d span b { display:block; font-size:clamp(24px, 7vmin, 64px); color:#888; text-shadow:1px 1px 0px rgba(255,255,255,0.8); transform:rotateZ(-35deg); position:relative; top:2px; }
.btn3d:hover span{ background:#fff; border-color:#ccc; transform:translateZ(10px); }
.btn3d:hover span b{ color:#666; }
.btn3d:active span{ transform:translateZ(4px)!important; box-shadow:1px 1px 0 #bbb, 4px 4px 10px rgba(0,0,0,0.2); transition-delay:0s!important; }
.hint{ margin-top:clamp(60px, 15vh, 120px); color:var(--text); font-size:13px; z-index:1; transform:rotateX(20deg); opacity:0.8; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

/* Level List UI */
.editor-menu-container { position: absolute; inset: 0; top: 60px; display: flex; gap: 24px; padding: 20px 40px 40px; max-width: 1200px; margin: 0 auto; }
.editor-menu-container.center-layout { justify-content: center; }
.level-list-section { flex: 1; display: flex; flex-direction: column; background: var(--panel-bg); color: var(--text-dark); border-radius: var(--radius); padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.level-list-section.full-width { max-width: 800px; width: 100%; margin: 0 auto; flex: none; height: 80%; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.section-header h3 { margin: 0; color: #5a4a2d; font-size: 18px; }
.list-actions { display: flex; gap: 10px; }
.level-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; }
.level-list.grid-list { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
  gap: 20px; 
  padding-bottom: 40px; 
}
/* Level Item */
.level-item { background: #fff; border: 2px solid #eee; padding: 12px 16px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.15s; color: var(--text-dark); }
.level-item:hover { border-color: #ddd; background: #fafafa; transform: translateX(2px); }
.level-item.active { border-color: var(--accent); background: #fffcf0; box-shadow: 0 0 0 2px rgba(242, 184, 76, 0.3); }
.level-info h4 { margin: 0; font-size: 16px; }
.level-info p { margin: 2px 0 0; font-size: 12px; color: #888; }
/* Official Level Item */
.level-item.official { 
  flex-direction: column; 
  align-items: center; 
  justify-content: center; 
  min-height: 140px; 
  text-align: center; 
  gap: 8px; 
  border-width: 3px; 
  position: relative;
  padding: 15px 10px;
}

/* STAGE X の文字 */
.level-item.official h4 { 
  font-size: 24px; 
  color: #555; 
  margin: 0; 
  line-height: 1.2;
}

/* 内部ID (stage_0 など) は非表示にする */
.level-item.official p {
  display: none; 
}

/* サブタイトル */
.level-item.official .sub-title { 
  font-size: 13px; 
  color: #888; 
  white-space: normal;
  line-height: 1.4;
  font-weight: bold;
}

/* EX Stages */
.level-item.official.ex {
  border-color: #ff4757;
  background: #fff5f5;
  box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);
}
.level-item.official.ex h4 {
  color: #d63031;
}

/* クリア済み、ロック状態などのスタイルはそのまま維持 */
.level-item.official.cleared { border-color: var(--play); background: #f0fff4; }
.level-item.official.cleared::after {
  content: "★"; position: absolute; top: 5px; right: 5px;
  color: #f1c40f; font-size: 18px;
}
.level-item.official.locked { filter: grayscale(1); opacity: 0.6; background: #ddd; }
.level-item.official:hover { transform: translateY(-3px); }

.level-details-section { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.details-card { background: var(--panel-bg); color: var(--text-dark); border-radius: var(--radius); padding: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 20px; animation: slideIn 0.3s ease; }
.details-card.hidden { display: none; }
.details-header h2 { margin: 0; font-size: 28px; line-height: 1.2; color: #444; }
.details-header p { margin: 5px 0; color: #b8860b; font-weight: bold; }
.detail-meta-grid { margin-top: 10px; font-size: 13px; color: #666; display: flex; flex-direction: column; gap: 4px; }
.preview-box { width: 100%; height: 200px; background: #ddd; border-radius: 12px; display: grid; place-items: center; font-size: 15px; color: #888; border: 4px dashed #ccc; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
.details-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 10px; }
.no-selection { text-align: center; color: rgba(255,255,255,0.8); background: rgba(0,0,0,0.2); padding: 40px; border-radius: var(--radius); }

/* Buttons */
.btn { border:0; border-radius:999px; padding:12px 24px; font-weight:900; letter-spacing:.05em; font-family: var(--font); cursor:pointer; background:rgba(255,255,255,.2); color:#fff; backdrop-filter:blur(10px); box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:all 0.15s ease; }
.btn.dark { background: #444; color: #fff; }
.btn.dark:hover { background: #222; }
.btn:hover{ transform:translateY(-2px); background:rgba(255,255,255,.3); }
.btn:active{ transform:translateY(0); }
.btn.primary{ background:var(--accent); color:#4e3600; }
.btn.primary:hover{ background:#ffc857; }
.btn.small{ padding:8px 16px; font-size:13px; }
.btn.action-play { background: var(--play); color: #fff; }
.btn.action-edit { background: #fff; color: #444; border: 2px solid #ddd; }
.btn.action-delete { background: #ffeaea; color: var(--danger); border: 2px solid #ffcccc; }
.btn.danger { background: #ff4757; color: #fff; }
.btn.skip { background: #9b59b6; color: #fff; }
.btn.skip:hover { background: #8e44ad; }

/* Modal */
.modal { background: #fff; color: #333; border: none; border-radius: var(--radius); padding: 30px; width: min(450px, 95vw); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
.modal::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
.modal h3 { text-align: center; color: #5a4a2d; margin-top: 0; }
.modal p { text-align: center; line-height: 1.6; }
.modal form input, .modal form select { width: 100%; padding: 12px; background: #f5f5f5; border: 2px solid #ddd; border-radius: 8px; color: #333; font-family: var(--font); margin-bottom: 15px; font-weight: bold; }
.modal form label span { font-size: 13px; color: #666; display: block; margin-bottom: 5px; font-weight: bold; }
.slide-modal { position: fixed; top: 0; right: 0; bottom: 0; left: auto; width: 400px; height: 100%; margin: 0; transform: translateX(100%); transition: transform 0.3s ease; background: #fdfdfd; box-shadow: -10px 0 40px rgba(0,0,0,0.3); border-radius: 0; display: flex; flex-direction: column; }
.slide-modal[open] { transform: translateX(0); }
.modal-header { padding: 20px; background: #eee; display: flex; justify-content: space-between; align-items: center; }
.btn-close { border: none; background: none; font-size: 24px; cursor: pointer; color: #888; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; color: var(--text-dark); }
.modal-footer { margin-top: 20px; text-align: right; }

/* Editor UI */
.editor-topbar { padding-right: 280px; }
.editor-info-area { display: flex; align-items: center; gap: 20px; }
.editor-timer { font-size: 14px; color: #fff; font-family: monospace; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; }
.editor-top-actions { display: flex; gap: 10px; }
.editor-palette { position: absolute; right: 20px; top: 80px; bottom: 100px; width: 220px; background: var(--panel-bg); color: var(--text-dark); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; transition: 0.3s ease; z-index: 500; }
.editor-palette.minimized { height: 50px; overflow: hidden; }
.palette-header { padding: 12px 16px; background: #eee; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
.palette-content { padding: 16px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.palette-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: #fff; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.1s; text-align: left; }
.palette-item:hover { background: #f9f9f9; transform: translateX(2px); }
.palette-item.active { border-color: var(--accent); background: #fffcf0; box-shadow: 0 0 0 2px rgba(242,184,76,0.4); }
.preview-tile { width: 32px; height: 32px; border-radius: 4px; border: 1px solid #ccc; display: grid; place-items: center; font-weight: bold; font-size: 14px; position:relative; overflow:hidden;}
.editor-bottom-actions { position: absolute; bottom: 30px; left: 30px; right: 260px; display: flex; justify-content: space-between; pointer-events: none; }
.editor-bottom-actions button { pointer-events: auto; }
.big-btn { padding: 16px 40px; font-size: 18px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
#btnTestPlay { background: var(--play); color: #fff; }
.test-play-ui { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 50px; display: flex; flex-direction: column; gap: 5px; align-items: center; z-index: 1000; border: 2px solid var(--play); text-align: center; }
.test-play-ui.hidden { display: none; }
.test-msg { color: #fff; font-weight: bold; }

/* Stage */
.editor-stage{ position:absolute; inset:0; display:flex; justify-content:center; align-items:center; perspective:1000px; }
.editor-grid { display:grid; grid-template-columns:repeat(var(--cols,8), 1fr); gap:2px; transform-style:preserve-3d; transform: scale(var(--gridScale, 1.5)) rotateX(55deg) rotateZ(45deg); background:rgba(0,0,0,0.2); padding:10px; border-radius:4px; transition: transform 0.5s ease; position:relative; }
.tile { width:50px; height:50px; background:#eee; border-radius:2px; cursor:pointer; position: relative; box-shadow: 1px 1px 0 #bbb, 2px 2px 0 #bbb; transition: transform 0.1s, filter 0.1s; transform-style: preserve-3d; }
.tile:hover{ transform:translateZ(10px); background: inherit; filter: brightness(1.15); box-shadow: inset 0 0 0 2px rgba(255,255,255,0.8); z-index: 50; }

/* Tiles */
.tile[data-type="0"], .preview-tile.void { background: transparent; box-shadow: none; border: 1px dashed rgba(255,255,255,0.1); }
.tile[data-type="1"], .preview-tile.normal { background: #eee; }
.tile[data-type="2"], .preview-tile.start { background: #ff9f43; }
.tile[data-type="3"], .preview-tile.goal { background: #feca57; overflow:visible; }

/* Inactive Goal (Darker) */
.tile[data-type="3"].inactive, .preview-tile.goal.inactive { 
  background: #b8860b; 
  box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 1px 1px 0 #888, 2px 2px 0 #888;
}
.tile[data-type="3"].inactive::after { color: #ccc; opacity: 0.5; }

.tile[data-type="4"], .preview-tile.switch-arrow { background: #fff; border: 3px solid #ccc; }
.tile[data-type="5"], .preview-tile.fixed-arrow { background: #555; }
.tile[data-type="6"], .preview-tile.turn-var { background: #dcdcdc; border: 3px solid #aaa; }
.tile[data-type="7"], .preview-tile.turn-fix { background: #aaa; }
.tile[data-type="8"], .preview-tile.u-turn { background: #888; }
.tile[data-type="9"], .preview-tile.glass { background: rgba(200, 240, 255, 0.8); border: 2px solid #81ecec; box-shadow: inset 0 0 10px rgba(255,255,255,0.5); opacity: 0.9; }
.tile[data-type="10"], .preview-tile.jump { background: #eee; }
.tile[data-type="10"]::before, .preview-tile.jump::before {
  content: ""; position: absolute; inset: 5px; background: #ff7675;
  clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
  box-shadow: inset 0 3px 0 rgba(255,255,255,0.4), inset 0 -3px 0 rgba(0,0,0,0.2), 0 3px 5px rgba(0,0,0,0.3);
  transform: translateZ(5px); z-index: 5;
}
.tile[data-type="10"][data-val="1"]::before, .preview-tile.jump[data-val="1"]::before { background: #ff3f34; }
.tile[data-type="10"][data-val="2"]::before, .preview-tile.jump[data-val="2"]::before { background: #0fbcf9; }
.tile[data-type="10"][data-val="3"]::before, .preview-tile.jump[data-val="3"]::before { background: #05c46b; }

.tile[data-type="11"], .preview-tile.warp { background: #333; box-shadow: 0 0 10px currentColor; }
.tile[data-type="11"]::before, .preview-tile.warp::before { content: ""; position: absolute; inset: 8px; border: 4px solid currentColor; border-radius: 50%; }
.tile[data-type="11"][data-val="1"], .preview-tile.warp.color-1 { color: var(--c1); }
.tile[data-type="11"][data-val="2"] { color: var(--c2); }
.tile[data-type="11"][data-val="3"] { color: var(--c3); }
.tile[data-type="11"][data-val="4"] { color: var(--c4); }
.tile[data-type="11"][data-val="5"] { color: var(--c5); }
.tile[data-type="11"][data-val="6"] { color: var(--c6); }
.tile[data-type="11"][data-val="7"] { color: var(--c7); }

.tile[data-type="12"], .preview-tile.switch { background: #ddd; }
.tile[data-type="12"]::before, .preview-tile.switch::before { content: ""; position: absolute; inset: 10px; border-radius: 50%; background: currentColor; box-shadow: 0 4px 0 rgba(0,0,0,0.3); transform: translateZ(5px); transition: transform 0.1s; }
.tile[data-type="12"].active::before { transform: translateZ(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
.tile[data-type="12"][data-val="1"], .preview-tile.switch.color-1 { color: var(--c1); }
.tile[data-type="12"][data-val="2"] { color: var(--c2); }
.tile[data-type="12"][data-val="3"] { color: var(--c3); }
.tile[data-type="12"][data-val="4"] { color: var(--c4); }
.tile[data-type="12"][data-val="5"] { color: var(--c5); }
.tile[data-type="12"][data-val="6"] { color: var(--c6); }
.tile[data-type="12"][data-val="7"] { color: var(--c7); }

.tile[data-type="13"], .tile[data-type="15"], .preview-tile.block, .preview-tile.block-off { background: currentColor; opacity: 1; transition: opacity 0.3s, transform 0.3s; }

/* Block OFF Visual (Wireframe) */
.tile.off, .preview-tile.block-off { background: transparent !important; border: 4px solid currentColor !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.3) !important; opacity: 0.6 !important; }

.tile[data-type="13"][data-val="1"], .tile[data-type="15"][data-val="1"], .preview-tile.block.color-1, .preview-tile.block-off.color-1 { color: var(--c1); }
.tile[data-type="13"][data-val="2"], .tile[data-type="15"][data-val="2"] { color: var(--c2); }
.tile[data-type="13"][data-val="3"], .tile[data-type="15"][data-val="3"] { color: var(--c3); }
.tile[data-type="13"][data-val="4"], .tile[data-type="15"][data-val="4"] { color: var(--c4); }
.tile[data-type="13"][data-val="5"], .tile[data-type="15"][data-val="5"] { color: var(--c5); }
.tile[data-type="13"][data-val="6"], .tile[data-type="15"][data-val="6"] { color: var(--c6); }
.tile[data-type="13"][data-val="7"], .tile[data-type="15"][data-val="7"] { color: var(--c7); }

/* Crystal (True 3D - Improved) */
.tile[data-type="14"], .preview-tile.crystal { background: #eee; }

.crystal-3d {
  position: absolute;
  top: 50%; left: 50%;
  width: 0; height: 0;
  transform-style: preserve-3d;
  animation: floatCrystal 2.5s ease-in-out infinite;
  pointer-events: none; z-index: 100;
}

/* 八面体風の構成要素 */
.crystal-3d::before, .crystal-3d::after {
  content: ""; position: absolute;
  left: -10px; top: -10px; width: 20px; height: 20px;
  background: rgba(142, 68, 173, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 0 10px rgba(165, 94, 234, 0.8);
  transform-origin: center;
}

/* 2枚の板を直交させて立体的に見せる */
.crystal-3d::before {
  transform: rotateY(0deg) rotateZ(45deg);
}
.crystal-3d::after {
  transform: rotateY(90deg) rotateZ(45deg);
}

/* 中心に輝くコア */
.crystal-3d .core {
  position: absolute; width: 14px; height: 14px;
  top: -7px; left: -7px;
  background: white; opacity: 0.8;
  transform: rotateX(45deg) rotateZ(45deg);
  box-shadow: 0 0 15px white;
}

.preview-tile.crystal::before {
  content: ""; width:12px; height:12px; background:#8e44ad; transform:rotate(45deg); box-shadow:0 0 4px #8e44ad;
}

@keyframes floatCrystal { 
  0%, 100% { transform: translateZ(30px) rotateY(0deg); } 
  50% { transform: translateZ(40px) rotateY(180deg); } 
}

/* Icons & Symbols */
.tile::after, .preview-tile::after { position: absolute; inset:0; display:grid; place-items:center; font-size: 24px; font-weight: bold; transform: rotate(var(--r, 0deg)); text-shadow: 0 1px 0 rgba(0,0,0,0.2); pointer-events: none; z-index: 20; }
.tile[data-type="2"]::after, .preview-tile.start::after { content: "↑"; color: #fff; }
.tile[data-type="3"]::after, .preview-tile.goal::after { content: "↑"; color: #fff; }
.tile[data-type="4"]::after, .preview-tile.switch-arrow::after { content: "↑"; color: #888; }
.tile[data-type="5"]::after, .preview-tile.fixed-arrow::after { content: "↑"; color: #fff; }
.tile[data-type="9"]::after, .preview-tile.glass::after { content: attr(data-val); color: #005588; font-size: 22px; text-shadow:none; transform: none; }
.tile[data-type="10"]::after, .preview-tile.jump::after { content: attr(data-val); color: #fff; font-size: 22px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); transform: translateZ(6px); z-index: 25; }

/* 90度転換 (SVG) - 太い回転矢印版 */
.tile[data-type="6"]::after, .preview-tile.turn-var::after {
  content: ""; 
  /* 4方向の太い矢印 (白) */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M25 55 V25 H55' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M52 10 L80 25 L52 40 Z' fill='%23fff'/%3E%3Cpath d='M45 25 H75 V55' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M90 52 L75 80 L60 52 Z' fill='%23fff'/%3E%3Cpath d='M75 45 V75 H45' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M48 90 L20 75 L48 60 Z' fill='%23fff'/%3E%3Cpath d='M55 75 H25 V45' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M10 48 L25 20 L40 48 Z' fill='%23fff'/%3E%3C/svg%3E");
  background-size: 85%; background-repeat: no-repeat; background-position: center; transform: scaleX(1); 
  filter: drop-shadow(0 1px 3px rgba(0,0,0,0.6)); /* 影を濃くして視認性UP */
}
.tile[data-type="6"][style*="--r: 90deg"]::after, .tile[data-type="6"][style*="--r: 270deg"]::after { transform: scaleX(-1); }

.tile[data-type="7"]::after, .preview-tile.turn-fix::after {
  content: ""; 
  /* 固定版 (同じ形状だが影の付き方等で統一感を出す) */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M25 55 V25 H55' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M52 10 L80 25 L52 40 Z' fill='%23fff'/%3E%3Cpath d='M45 25 H75 V55' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M90 52 L75 80 L60 52 Z' fill='%23fff'/%3E%3Cpath d='M75 45 V75 H45' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M48 90 L20 75 L48 60 Z' fill='%23fff'/%3E%3Cpath d='M55 75 H25 V45' fill='none' stroke='%23fff' stroke-width='14' stroke-linejoin='round' stroke-linecap='round'/%3E%3Cpath d='M10 48 L25 20 L40 48 Z' fill='%23fff'/%3E%3C/svg%3E");
  background-size: 85%; background-repeat: no-repeat; background-position: center; transform: scaleX(1);
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
}
.tile[data-type="7"][style*="--r: 90deg"]::after, .tile[data-type="7"][style*="--r: 270deg"]::after { transform: scaleX(-1); }

/* Uターン */
.tile[data-type="8"]::after, .preview-tile.u-turn::after {
  content: "";
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='12' fill='none' stroke='%23fff' stroke-width='6'/%3E%3Cpath d='M50 38 L50 15 M50 62 L50 85 M38 50 L15 50 M62 50 L85 50' stroke='%23fff' stroke-width='6' stroke-linecap='round'/%3E%3Cpath d='M50 15 L40 25 M50 15 L60 25 M50 85 L40 75 M50 85 L60 75 M15 50 L25 40 M15 50 L25 60 M85 50 L75 40 M85 50 L75 60' stroke='%23fff' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-size: 80%; background-repeat: no-repeat; background-position: center; transform: rotate(var(--r, 0deg));
}


/* --- トグルスイッチ (三角) --- */
.tile[data-type="16"], .preview-tile.toggle-switch {
  background: #ddd;
  transition: all 0.3s;
}

/* デフォルトは赤画像 */
.tile[data-type="16"]::after, .preview-tile.toggle-switch::after {
  content: "";
  background-size: 70%;
  background-repeat: no-repeat;
  background-position: center;
  transition: all 0.3s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 20 L85 80 H15 Z' fill='%23ff4757' stroke='%23fff' stroke-width='6' stroke-linejoin='round'/%3E%3C/svg%3E");
}

/* 青状態 (.toggle-blue) なら青画像 */
.tile[data-type="16"].toggle-blue::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 20 L85 80 H15 Z' fill='%231e90ff' stroke='%23fff' stroke-width='6' stroke-linejoin='round'/%3E%3C/svg%3E");
}

/* 踏んだときのアニメーション */
.tile[data-type="16"].active { transform: scale(0.9); }


/* --- ON/OFF矢印 (固定のみ) --- */
.tile[data-type="18"], .preview-tile.toggle-arrow-fix {
  transition: background 0.3s;
  background: #444; border: 2px solid #333;
}

/* 矢印SVG (デフォルト: 上=赤, 下=灰) */
.tile[data-type="18"]::after, .preview-tile.toggle-arrow-fix::after {
  content: "";
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C!-- Up Arrow (Red) --%3E%3Cpath d='M50 10 L80 40 H60 V55 H40 V40 H20 Z' fill='%23ff4757' stroke='%23fff' stroke-width='4' stroke-linejoin='round'/%3E%3C!-- Down Arrow (Gray) --%3E%3Cpath d='M50 90 L20 60 H40 V45 H60 V60 H80 Z' fill='%23999' stroke='%23fff' stroke-width='4' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-size: 80%;
  background-repeat: no-repeat;
  background-position: center;
  transform: rotate(var(--r, 0deg));
  width: 100%; height: 100%;
}

/* 青状態: 上=灰, 下=青 */
.tile[data-type="18"].toggle-blue::after {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3C!-- Up Arrow (Gray) --%3E%3Cpath d='M50 10 L80 40 H60 V55 H40 V40 H20 Z' fill='%23999' stroke='%23fff' stroke-width='4' stroke-linejoin='round'/%3E%3C!-- Down Arrow (Blue) --%3E%3Cpath d='M50 90 L20 60 H40 V45 H60 V60 H80 Z' fill='%231e90ff' stroke='%23fff' stroke-width='4' stroke-linejoin='round'/%3E%3C/svg%3E");
}


.tile[data-type="3"]::before { content: ""; position: absolute; inset:0; background: radial-gradient(circle, rgba(255,255,255,0.8) 10%, transparent 70%); opacity: 0; animation: floatSparkle 2s infinite linear; pointer-events: none; z-index: 10; }
/* Rainbow Ripple */
.tile.rainbow-effect::before { 
  content: ""; position: absolute; inset: 0; border-radius: 2px; z-index: 15; 
  animation: rainbowFlash 1.2s ease-out forwards; 
}
@keyframes rainbowFlash { 
  0% { background-color: rgba(255, 94, 87, 0.8); } 
  20% { background-color: rgba(255, 221, 89, 0.8); } 
  40% { background-color: rgba(5, 196, 107, 0.8); } 
  60% { background-color: rgba(15, 188, 249, 0.8); } 
  80% { background-color: rgba(142, 68, 173, 0.8); opacity: 1; } 
  100% { background-color: rgba(142, 68, 173, 0); opacity: 0; } 
}
.tile.flash-white::before { content: ""; position: absolute; inset:0; background: #fff; z-index: 100; animation: flashAnim 0.4s ease-out forwards; }
@keyframes flashAnim { from{opacity:1;} to{opacity:0;} }

.ball { position: absolute; width: 30px; height: 30px; background: radial-gradient(circle at 35% 35%, #fff, #4a90e2, #2c3e50); border-radius: 50%; top: 0; left: 0; transform-origin: center center; box-shadow: -5px 5px 10px rgba(0,0,0,0.4); z-index: 100; pointer-events: none; }
.particle { position: absolute; width: 6px; height: 6px; background: #fff; border-radius: 50%; pointer-events: none; z-index: 101; }
.topbar{ position:absolute; top:0; left:0; right:0; height: 60px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.topbar__title{ font-weight:bold; letter-spacing:0.1em; color: var(--accent); font-size: 18px; }
.loading-overlay { position:fixed; inset:0; background:#111; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.loading-overlay.active { opacity:1; pointer-events:auto; }
.spinner { width:50px; height:50px; border:5px solid var(--accent); border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes logoPop{ to { opacity:1; transform: translateY(0) scale(1); } }
@keyframes logoFloat{ 0%,100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-6px) scale(1.002); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes slideIn { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform: translateX(0); } }
@keyframes floatSparkle { 0%{ transform:translateZ(0) scale(0.5); opacity:0; } 50%{ opacity:0.8; } 100%{ transform:translateZ(60px) scale(1.2); opacity:0; } }

/* Play Screen UI */
.play-ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 500; }
.play-intro { position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%); text-align: center; }
.play-intro h1 { font-size: 40px; color: var(--accent); margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.5); opacity: 0; transition: color 0.5s;}
/* EX Mode Title Color */
.play-intro h1.ex-mode { color: var(--ex-title); }

.play-intro p { margin: 5px 0; font-size: 18px; color: #fff; opacity: 0; }
.play-timer-area { position: absolute; top: 70px; right: 20px; background: rgba(0,0,0,0.4); padding: 8px 16px; border-radius: 8px; font-family: monospace; font-size: 16px; color: #fff; opacity: 0; }
.play-stage-container { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; perspective:1000px; }

/* In-Game Menu */
.play-controls {
  position: absolute; top: 70px; left: 20px;
  display: flex; gap: 10px; pointer-events: auto; z-index: 800;
}

/* Clear Overlay */
.clear-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
.clear-overlay.active { opacity: 1; pointer-events: auto; }
.clear-overlay.hidden { display: none; }
.clear-text-container { display: flex; gap: 15px; perspective: 500px; margin-bottom: 40px; }
.clear-char {
  width: 60px; height: 100px; background: var(--accent); color: #fff;
  font-size: 50px; display: flex; justify-content: center; align-items: center;
  font-weight: 900; border-radius: 8px;
  box-shadow: 0 10px 0 #dda335, 0 20px 20px rgba(0,0,0,0.4);
  transform: rotateX(20deg); opacity: 0;
}
.clear-actions { display: flex; gap: 20px; opacity: 0; transform: translateY(20px); transition: 0.5s ease 1s; }
.clear-overlay.active .clear-actions { opacity: 1; transform: translateY(0); }

/* Tutorial Guide */
.tutorial-guide {
  position: absolute;
  background: #fff;
  color: #333;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  pointer-events: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 1000;
  white-space: nowrap;
  
  /* Center anchor */
  left: 50%; top: 50%; 
  
  /* Counter-rotate to face screen and lift up */
  animation: floatGuide 1.5s ease-in-out infinite;
}

.tutorial-guide::after {
  content: ""; position: absolute;
  left: 50%; bottom: -6px; transform: translateX(-50%);
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 6px solid #fff;
}

@keyframes floatGuide {
  0%, 100% {
    transform: translate3d(-50%, -100%, 50px) rotateZ(-45deg) rotateX(-45deg) scale(1);
  }
  50% {
    transform: translate3d(-50%, -100%, 60px) rotateZ(-45deg) rotateX(-45deg) scale(1);
  }
}

/* Data Reset Button Area */
.data-reset-area {
  margin-top: 20px;
  text-align: center;
}
.btn-text-danger {
  background: none; border: none;
  color: #888; font-size: 12px;
  text-decoration: underline;
  cursor: pointer;
}
.btn-text-danger:hover { color: var(--danger); }

/* --- UI Animation Classes --- */
/* 入場 (Enter) */
.ui-enter-active .topbar {
  animation: slideDownFade 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

.ui-enter-active .level-list-section,
.ui-enter-active .level-details-section,
.ui-enter-active .editor-palette, 
.ui-enter-active .editor-stage,
.ui-enter-active .editor-bottom-actions {
  opacity: 0;
  animation: slideUpFade 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

.ui-enter-active .level-list-section { animation-delay: 0.1s; }
.ui-enter-active .level-details-section { animation-delay: 0.2s; }

.ui-enter-active .editor-stage { animation-delay: 0.1s; }
.ui-enter-active .editor-palette { animation-delay: 0.2s; }
.ui-enter-active .editor-bottom-actions { animation-delay: 0.3s; }

/* 退場 (Exit) - 追加部分 */
.ui-exit-active {
  pointer-events: none; /* アニメーション中の操作無効化 */
}

.ui-exit-active .topbar {
  animation: slideUpFadeOut 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

.ui-exit-active .level-list-section,
.ui-exit-active .level-details-section,
.ui-exit-active .editor-palette,
.ui-exit-active .editor-stage,
.ui-exit-active .editor-bottom-actions,
.ui-exit-active .editor-menu-container {
  animation: slideDownFadeOut 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
}

/* 入場キーフレーム */
@keyframes slideDownFade {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUpFade {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 退場キーフレーム - 追加部分 */
@keyframes slideUpFadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-20px); }
}

@keyframes slideDownFadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(30px); }
}

/* First Time Guide Bubble */
.ftue-guide-bubble {
  position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
  background: var(--accent); color: #4e3600;
  padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
  white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  animation: bounceGuide 1.5s infinite; z-index: 100; pointer-events: none;
}
.ftue-guide-bubble::after {
  content: ""; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
  border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid var(--accent);
}
@keyframes bounceGuide {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(-10px); }
}

/* Flip Reveal Animation */
.level-item.official.flip-reveal {
  animation: flipCard 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
  transform-style: preserve-3d;
}
@keyframes flipCard {
  0% { transform: rotateX(-180deg); opacity: 0; }
  50% { opacity: 0.5; }
  100% { transform: rotateX(0deg); opacity: 1; }
}

/* All Clear Animation Overlay */
.all-clear-overlay {
  position: fixed; inset: 0;
  background: rgba(0, 0, 0, 0.85);
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  z-index: 10000;
  opacity: 1; pointer-events: none; /* Allow click through if needed, but usually blocks */
  transition: opacity 1s ease;
}
.all-clear-overlay.hidden {
  opacity: 0; pointer-events: none;
}

.congrats-text {
  font-size: 48px; font-weight: bold; color: var(--accent);
  text-align: center; line-height: 1.4;
  text-shadow: 0 0 20px rgba(242, 184, 76, 0.6);
  opacity: 0; transform: scale(0.8);
  animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.ex-unlock-text {
  position: absolute; bottom: 15%;
  font-size: 28px; font-weight: bold; color: #ff4757;
  text-align: center; line-height: 1.5;
  text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
  opacity: 0; transform: translateY(20px);
}

.ex-unlock-text.visible {
  animation: slideUpFade 1s ease forwards;
}

@keyframes popIn {
  to { opacity: 1; transform: scale(1); }
}

@media (max-width:768px){ .editor-menu-container { flex-direction: column; padding: 10px; top: 60px; gap: 10px; } .level-details-section { order: -1; } .editor-topbar { padding-right: 10px; } }
